{% extends "base.html" %}
{% block title %}Site Auditor - MySEO King{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-sm mb-4">
                <div class="card-body p-5 text-center">
                    <h1 class="h3 mb-3 fw-bold"><i class="fas fa-stethoscope text-primary"></i> Professional Site Auditor</h1>
                    <p class="text-muted mb-4">Analyze any URL for technical SEO errors, speed issues, and metadata.</p>
                    
                    <div class="input-group input-group-lg">
                        <input type="text" id="auditUrl" class="form-control" placeholder="Enter Website URL (e.g., https://example.com)">
                        <button class="btn btn-primary px-4" onclick="runAudit()">
                            <i class="fas fa-search"></i> Analyze Now
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loader" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                <p class="mt-3 text-muted">Crawling website... this may take 10-15 seconds.</p>
            </div>

            <!-- Results Area -->
            <div id="results" style="display: none;">
                <!-- Score Card -->
                <div class="card shadow-sm mb-4 border-0 overflow-hidden">
                    <div class="card-body p-0 d-flex">
                        <div class="bg-primary p-4 text-white d-flex flex-column align-items-center justify-content-center" style="width: 150px;">
                            <span class="display-4 fw-bold" id="scoreVal">0</span>
                            <small>SEO SCORE</small>
                        </div>
                        <div class="p-4 flex-grow-1 d-flex align-items-center justify-content-between">
                            <div>
                                <h4 id="metaTitle" class="mb-1 fw-bold">Page Title</h4>
                                <a href="#" id="metaUrl" target="_blank" class="text-muted text-decoration-none">https://example.com</a>
                            </div>
                            <!-- PDF BUTTON -->
                            <button class="btn btn-outline-danger" onclick="downloadPDF()">
                                <i class="fas fa-file-pdf"></i> Download Report
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card shadow-sm h-100 border-danger border-top-0 border-end-0 border-bottom-0 border-3">
                            <div class="card-header bg-white fw-bold text-danger">
                                <i class="fas fa-exclamation-circle"></i> Critical Issues
                            </div>
                            <div class="card-body">
                                <ul id="issuesList" class="list-unstyled mb-0"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm h-100 border-success border-top-0 border-end-0 border-bottom-0 border-3">
                            <div class="card-header bg-white fw-bold text-success">
                                <i class="fas fa-check-circle"></i> Passed Checks
                            </div>
                            <div class="card-body">
                                <ul id="passedList" class="list-unstyled mb-0"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentAuditData = null; // Store data for PDF

async function runAudit() {
    const url = document.getElementById('auditUrl').value;
    if(!url) return alert("Please enter a URL");

    document.getElementById('loader').style.display = 'block';
    document.getElementById('results').style.display = 'none';

    try {
        const res = await fetch('/api/audit-site', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url: url})
        });
        
        const data = await res.json();
        if(data.error) throw new Error(data.error);

        currentAuditData = data; // Save for PDF

        // UI Updates
        document.getElementById('scoreVal').innerText = data.score;
        document.getElementById('metaTitle').innerText = data.meta.title;
        document.getElementById('metaUrl').innerText = data.meta.url;
        document.getElementById('metaUrl').href = data.meta.url;

        const issuesList = document.getElementById('issuesList');
        issuesList.innerHTML = '';
        if(data.issues.length === 0) {
            issuesList.innerHTML = '<li class="text-muted">No critical issues found! Great job.</li>';
        } else {
            data.issues.forEach(i => {
                issuesList.innerHTML += `<li class="mb-2"><i class="fas fa-times text-danger me-2"></i> ${i.msg}</li>`;
            });
        }

        const passedList = document.getElementById('passedList');
        passedList.innerHTML = '';
        data.passed.forEach(p => {
            passedList.innerHTML += `<li class="mb-2"><i class="fas fa-check text-success me-2"></i> ${p}</li>`;
        });

        document.getElementById('loader').style.display = 'none';
        document.getElementById('results').style.display = 'block';

    } catch(e) {
        alert(e.message);
        document.getElementById('loader').style.display = 'none';
    }
}

async function downloadPDF() {
    if(!currentAuditData) return;
    
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    
    try {
        const res = await fetch('/api/generate-report', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                url: currentAuditData.meta.url,
                score: currentAuditData.score,
                issues: currentAuditData.issues,
                passed: currentAuditData.passed
            })
        });
        
        if(res.status !== 200) throw new Error("Failed to generate PDF");
        
        // Trigger Download
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "SEO_Audit_Report.pdf";
        document.body.appendChild(a); 
        a.click();
        a.remove();
        
    } catch(e) {
        alert("Error generating PDF");
    } finally {
        btn.innerHTML = originalText;
    }
}
</script>
{% endblock %}
